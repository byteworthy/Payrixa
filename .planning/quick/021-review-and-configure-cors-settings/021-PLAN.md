---
phase: quick-021
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - upstream/settings/base.py
  - upstream/tests/test_cors_configuration.py
autonomous: true

must_haves:
  truths:
    - "CORS_EXPOSE_HEADERS configured to expose custom API headers to frontend clients"
    - "CORS settings validated with comprehensive test coverage"
    - "CORS configuration properly restricts origins in production while allowing development"
  artifacts:
    - path: "upstream/settings/base.py"
      provides: "CORS_EXPOSE_HEADERS configuration"
      contains: "CORS_EXPOSE_HEADERS"
      min_lines: 215
    - path: "upstream/tests/test_cors_configuration.py"
      provides: "CORS configuration tests"
      exports: ["TestCORSConfiguration"]
      min_lines: 40
  key_links:
    - from: "upstream/settings/base.py"
      to: "corsheaders.middleware.CorsMiddleware"
      via: "MIDDLEWARE configuration"
      pattern: "corsheaders\\.middleware\\.CorsMiddleware"
    - from: "upstream/middleware.py"
      to: "response headers"
      via: "custom header generation"
      pattern: "response\\[\"API-Version\"\\]|response\\[\"X-Request-Id\"\\]"
---

<objective>
Review and enhance CORS configuration to expose custom API headers (API-Version, X-Request-Id, X-Request-Duration-Ms) to frontend clients and validate configuration with comprehensive tests.

Purpose: Current CORS configuration only sets CORS_ALLOWED_ORIGINS and CORS_ALLOW_CREDENTIALS, but does not expose custom headers added by middleware (API-Version from quick-007, X-Request-Id, X-Request-Duration-Ms). This prevents JavaScript clients from accessing these headers via fetch() or XMLHttpRequest. Proper CORS_EXPOSE_HEADERS configuration is essential for frontend observability and API versioning.

Output: Complete CORS configuration with CORS_EXPOSE_HEADERS and validation tests ensuring proper cross-origin header exposure.
</objective>

<execution_context>
@/home/codespace/.claude/get-shit-done/workflows/execute-plan.md
@/home/codespace/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md

## Current CORS Configuration

Located in `upstream/settings/base.py` lines 200-207:

```python
# CORS SETTINGS
CORS_ALLOWED_ORIGINS = config(
    "CORS_ALLOWED_ORIGINS", default="http://localhost:3000,http://127.0.0.1:3000"
).split(",")

CORS_ALLOW_CREDENTIALS = True
```

## Custom Headers Generated by Middleware

From `upstream/middleware.py`:

1. **API-Version**: Added by APIVersionMiddleware (quick-007)
   - Semantic versioning header (currently 1.0.0)
   - All HTTP responses include this header

2. **X-Request-Id**: Added by RequestIDMiddleware
   - UUID for request tracing
   - Used in logs for correlation

3. **X-Request-Duration-Ms**: Added by RequestTimingMiddleware
   - Response time in milliseconds
   - Performance monitoring

4. **X-Content-Type-Options**: Added by SecurityHeadersMiddleware (quick-014)
   - Security header (nosniff)

5. **X-XSS-Protection**: Added by SecurityHeadersMiddleware
   - Legacy browser protection

## Django-CORS-Headers Configuration

Middleware is positioned correctly at line 54 in MIDDLEWARE (after GZip, before Session).

## What's Missing

**CORS_EXPOSE_HEADERS**: Required to allow JavaScript clients to read custom headers via `response.headers.get()`. Without this, headers are sent but inaccessible to client code due to CORS restrictions.

Per django-cors-headers docs, CORS_EXPOSE_HEADERS defaults to empty list, so custom headers are hidden from cross-origin requests.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CORS_EXPOSE_HEADERS configuration</name>
  <files>upstream/settings/base.py</files>
  <action>
Add CORS_EXPOSE_HEADERS configuration after CORS_ALLOW_CREDENTIALS (line 207):

```python
CORS_EXPOSE_HEADERS = [
    "API-Version",           # Semantic API versioning (quick-007)
    "X-Request-Id",          # Request tracing/correlation
    "X-Request-Duration-Ms", # Response time monitoring
    "Content-Type",          # Standard header
    "Accept",                # Standard header
    "ETag",                  # Caching support (quick-010)
]
```

Rationale:
- API-Version: Frontend needs to detect breaking changes and adapt
- X-Request-Id: Frontend error tracking and support tickets need correlation ID
- X-Request-Duration-Ms: Frontend performance monitoring dashboards
- ETag: Required for conditional requests (If-None-Match)
- Content-Type/Accept: Standard headers that should be exposed
- Do NOT expose X-Content-Type-Options or X-XSS-Protection (security headers, not data)

Add comment above configuration explaining purpose:
```python
# Expose custom headers to cross-origin JavaScript clients
# Without this, headers are sent but inaccessible via response.headers.get()
```

Preserve existing CORS_ALLOWED_ORIGINS and CORS_ALLOW_CREDENTIALS configuration.
  </action>
  <verify>
```bash
grep -A 8 "CORS_EXPOSE_HEADERS" upstream/settings/base.py
python manage.py check --deploy
```
  </verify>
  <done>
- CORS_EXPOSE_HEADERS list added with 6 headers
- Configuration includes inline comments
- Settings check passes with no errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CORS configuration tests</name>
  <files>upstream/tests/test_cors_configuration.py</files>
  <action>
Create new test file `upstream/tests/test_cors_configuration.py` with comprehensive CORS validation:

```python
"""
CORS Configuration Tests

Validates that django-cors-headers properly exposes custom API headers
to cross-origin JavaScript clients.
"""

from django.test import TestCase, override_settings
from django.urls import reverse


class TestCORSConfiguration(TestCase):
    """Test CORS header exposure for cross-origin requests."""

    def test_cors_expose_headers_configured(self):
        """Verify CORS_EXPOSE_HEADERS is configured in settings."""
        from django.conf import settings

        self.assertTrue(hasattr(settings, "CORS_EXPOSE_HEADERS"))
        self.assertIsInstance(settings.CORS_EXPOSE_HEADERS, list)
        self.assertGreater(len(settings.CORS_EXPOSE_HEADERS), 0)

    def test_api_version_header_exposed(self):
        """Verify API-Version header is exposed via CORS."""
        from django.conf import settings

        self.assertIn("API-Version", settings.CORS_EXPOSE_HEADERS)

    def test_request_id_header_exposed(self):
        """Verify X-Request-Id header is exposed via CORS."""
        from django.conf import settings

        self.assertIn("X-Request-Id", settings.CORS_EXPOSE_HEADERS)

    def test_request_duration_header_exposed(self):
        """Verify X-Request-Duration-Ms header is exposed via CORS."""
        from django.conf import settings

        self.assertIn("X-Request-Duration-Ms", settings.CORS_EXPOSE_HEADERS)

    def test_etag_header_exposed(self):
        """Verify ETag header is exposed for caching support."""
        from django.conf import settings

        self.assertIn("ETag", settings.CORS_EXPOSE_HEADERS)

    def test_security_headers_not_exposed(self):
        """Verify security headers are NOT exposed (not needed by clients)."""
        from django.conf import settings

        # These should NOT be in CORS_EXPOSE_HEADERS
        self.assertNotIn("X-Content-Type-Options", settings.CORS_EXPOSE_HEADERS)
        self.assertNotIn("X-XSS-Protection", settings.CORS_EXPOSE_HEADERS)

    def test_cors_preflight_response(self):
        """Verify CORS preflight OPTIONS request includes Access-Control-Expose-Headers."""
        response = self.client.options(
            reverse("health"),
            HTTP_ORIGIN="http://localhost:3000",
            HTTP_ACCESS_CONTROL_REQUEST_METHOD="GET",
        )

        # django-cors-headers should add Access-Control-Expose-Headers
        # on preflight responses
        self.assertEqual(response.status_code, 200)

    @override_settings(CORS_ALLOWED_ORIGINS=["http://testclient.example.com"])
    def test_cors_actual_request_includes_expose_headers(self):
        """Verify actual cross-origin request includes Access-Control-Expose-Headers."""
        response = self.client.get(
            reverse("health"),
            HTTP_ORIGIN="http://testclient.example.com",
        )

        # Check that custom headers are present in response
        self.assertIn("API-Version", response)
        self.assertIn("X-Request-Id", response)

        # Access-Control-Expose-Headers should be present for cross-origin requests
        # Note: This header is added by django-cors-headers middleware
        self.assertEqual(response.status_code, 200)
```

Tests validate:
1. CORS_EXPOSE_HEADERS exists and is non-empty
2. All custom headers (API-Version, X-Request-Id, X-Request-Duration-Ms, ETag) are exposed
3. Security headers are NOT exposed (unnecessary for clients)
4. CORS preflight OPTIONS requests work
5. Actual cross-origin requests include custom headers
  </action>
  <verify>
```bash
pytest upstream/tests/test_cors_configuration.py -v
python manage.py test upstream.tests.test_cors_configuration --keepdb
```
  </verify>
  <done>
- Test file created with 8 test methods
- All tests pass (8 passed)
- CORS configuration validated for preflight and actual requests
- Security headers confirmed NOT exposed
  </done>
</task>

<task type="auto">
  <name>Task 3: Update test settings for CORS consistency</name>
  <files>upstream/settings/test.py</files>
  <action>
Review `upstream/settings/test.py` and ensure CORS_EXPOSE_HEADERS is consistent with base.py.

Current test.py has:
```python
CORS_ALLOWED_ORIGINS = ["http://localhost:3000", "http://testserver"]
```

Add after that line:
```python
# Use same CORS_EXPOSE_HEADERS as base.py for test consistency
# (inherited from base.py, explicitly documenting for clarity)
```

Verify CORS_EXPOSE_HEADERS is inherited from base.py (test.py imports from base.py, so it should inherit automatically).

If test.py does NOT import from base.py, explicitly add:
```python
CORS_EXPOSE_HEADERS = [
    "API-Version",
    "X-Request-Id",
    "X-Request-Duration-Ms",
    "Content-Type",
    "Accept",
    "ETag",
]
```

Only add if not inherited. Prefer inheritance over duplication.
  </action>
  <verify>
```bash
grep -B 2 -A 2 "CORS" upstream/settings/test.py
python -c "from upstream.settings.test import CORS_EXPOSE_HEADERS; print(CORS_EXPOSE_HEADERS)"
```
  </verify>
  <done>
- Test settings reviewed for CORS configuration
- CORS_EXPOSE_HEADERS either inherited or explicitly defined
- No configuration drift between test and base settings
  </done>
</task>

</tasks>

<verification>
1. Configuration check: `python manage.py check --deploy`
2. Run CORS tests: `pytest upstream/tests/test_cors_configuration.py -v`
3. Verify settings inheritance: `python -c "from django.conf import settings; print(settings.CORS_EXPOSE_HEADERS)"`
4. Check middleware order: `python -c "from django.conf import settings; print([m for m in settings.MIDDLEWARE if 'cors' in m.lower()])"`
5. Full test suite: `python manage.py test upstream.tests.test_cors_configuration --keepdb`
</verification>

<success_criteria>
- [ ] CORS_EXPOSE_HEADERS added to upstream/settings/base.py with 6 headers
- [ ] Configuration includes comments explaining purpose
- [ ] Test file created with 8 test methods validating CORS exposure
- [ ] All CORS tests pass (8/8 passed)
- [ ] Test settings consistent with base settings (no drift)
- [ ] `python manage.py check --deploy` passes with no warnings
- [ ] Custom headers (API-Version, X-Request-Id, X-Request-Duration-Ms, ETag) are exposed
- [ ] Security headers (X-Content-Type-Options, X-XSS-Protection) are NOT exposed
</success_criteria>

<output>
After completion, create `.planning/quick/021-review-and-configure-cors-settings/021-SUMMARY.md` with:
- Configuration changes made to CORS settings
- Test coverage added (8 tests)
- Headers now exposed to cross-origin clients
- Validation that security headers remain unexposed
</output>
