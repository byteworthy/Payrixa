---
phase: 06-database-indexes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - upstream/models.py
  - upstream/alerts/models.py
  - upstream/integrations/models.py
autonomous: true

must_haves:
  truths:
    - "Database queries filter by status, enabled flags, and foreign keys without full table scans"
    - "Webhook retry queries use indexes for status-based lookups"
    - "Alert rule evaluation queries use indexes for enabled+customer filters"
    - "User profile lookups use indexes for user and customer foreign keys"
  artifacts:
    - path: "upstream/models.py"
      provides: "UserProfile model with db_index on foreign keys"
      min_lines: 850
    - path: "upstream/alerts/models.py"
      provides: "AlertRule and NotificationChannel with db_index on enabled field"
      min_lines: 140
    - path: "upstream/integrations/models.py"
      provides: "WebhookDelivery with composite indexes for retry logic"
      min_lines: 110
  key_links:
    - from: "upstream/alerts/models.py"
      to: "AlertRule.enabled filter"
      via: "db_index=True on enabled field"
      pattern: "enabled.*db_index"
    - from: "upstream/integrations/models.py"
      to: "WebhookDelivery retry queries"
      via: "composite index on status+next_attempt_at"
      pattern: "models\\.Index.*status.*next_attempt_at"
---

<objective>
Add missing database indexes to improve query performance for webhook retry logic, alert rule evaluation, and user profile lookups.

Purpose: Prevent full table scans on frequently queried fields (status, enabled, foreign keys)
Output: Migration file with 6 new database indexes across 3 model files
</objective>

<execution_context>
@/workspaces/codespaces-django/.planning/get-shit-done/workflows/execute-plan.md
@/workspaces/codespaces-django/.planning/get-shit-done/templates/summary.md
</execution_context>

<context>
@/workspaces/codespaces-django/.planning/PROJECT.md
@/workspaces/codespaces-django/.planning/ROADMAP.md
@/workspaces/codespaces-django/.planning/STATE.md
@/workspaces/codespaces-django/upstream/models.py
@/workspaces/codespaces-django/upstream/alerts/models.py
@/workspaces/codespaces-django/upstream/integrations/models.py
@/workspaces/codespaces-django/upstream/api/views.py
</context>

<tasks>

<task type="auto">
  <name>Add indexes to UserProfile, AlertRule, and NotificationChannel models</name>
  <files>
    upstream/models.py
    upstream/alerts/models.py
  </files>
  <action>
**In upstream/models.py:**

Locate the UserProfile model (around line 830-892). Add db_index to foreign key fields:

```python
user = models.OneToOneField(
    settings.AUTH_USER_MODEL,
    on_delete=models.CASCADE,
    related_name="profile",
    db_index=True  # Add this
)
customer = models.ForeignKey(
    Customer,
    on_delete=models.CASCADE,
    related_name="user_profiles",
    db_index=True  # Add this
)
```

**In upstream/alerts/models.py:**

1. Locate AlertRule model (around line 7-113). Add db_index to enabled field:

```python
enabled = models.BooleanField(default=True, db_index=True)
```

2. Add Meta.indexes section after unique_together:

```python
class Meta:
    verbose_name = "Alert Rule"
    verbose_name_plural = "Alert Rules"
    unique_together = ("customer", "name")
    indexes = [
        models.Index(
            fields=["customer", "enabled"],
            name="alertrule_cust_enabled_idx",
        ),
    ]
```

3. Locate NotificationChannel model (around line 115-140). Add db_index to enabled field:

```python
enabled = models.BooleanField(default=True, db_index=True)
```

4. Add Meta.indexes section after unique_together:

```python
class Meta:
    verbose_name = "Notification Channel"
    verbose_name_plural = "Notification Channels"
    unique_together = ("customer", "name")
    indexes = [
        models.Index(
            fields=["customer", "enabled", "channel_type"],
            name="notifchan_cust_enabled_idx",
        ),
    ]
```

Why these indexes:
- UserProfile foreign keys are used in get_user_customer() lookups (views.py line 473)
- AlertRule.enabled is filtered in rule evaluation queries
- NotificationChannel.enabled+channel_type is filtered when selecting delivery channels
  </action>
  <verify>
```bash
cd /workspaces/codespaces-django
grep -n "db_index=True" upstream/models.py | grep -E "(user|customer) ="
grep -n "db_index=True" upstream/alerts/models.py | grep "enabled"
grep -A5 "class Meta:" upstream/alerts/models.py | grep -E "(indexes|alertrule_cust_enabled)"
```
  </verify>
  <done>
- UserProfile.user and UserProfile.customer have db_index=True
- AlertRule.enabled has db_index=True with composite index on customer+enabled
- NotificationChannel.enabled has db_index=True with composite index on customer+enabled+channel_type
  </done>
</task>

<task type="auto">
  <name>Add indexes to WebhookDelivery and IntegrationLog models</name>
  <files>
    upstream/integrations/models.py
  </files>
  <action>
**In upstream/integrations/models.py:**

1. Locate WebhookDelivery model (around line 77-104). Add Meta.indexes section after ordering:

```python
class Meta:
    verbose_name = 'Webhook Delivery'
    verbose_name_plural = 'Webhook Deliveries'
    ordering = ['-created_at']
    indexes = [
        # Webhook retry query: filter by status + next_attempt_at
        models.Index(
            fields=["status", "next_attempt_at"],
            name="webhook_retry_idx",
        ),
        # Delivery history per endpoint
        models.Index(
            fields=["endpoint", "-created_at"],
            name="webhook_endpoint_hist_idx",
        ),
    ]
```

2. Locate IntegrationLog model (around line 42-56). Add Meta.indexes section after ordering:

```python
class Meta:
    verbose_name = 'Integration Log'
    verbose_name_plural = 'Integration Logs'
    ordering = ['-start_time']
    indexes = [
        # Recent logs per connection
        models.Index(
            fields=["connection", "-start_time"],
            name="intlog_conn_time_idx",
        ),
        # Error monitoring queries
        models.Index(
            fields=["status", "-start_time"],
            name="intlog_status_time_idx",
        ),
    ]
```

Why these indexes:
- WebhookDelivery retry logic (schedule_next_attempt) queries by status='retrying' and next_attempt_at
- IntegrationLog is queried by connection for recent sync history
- Status-based monitoring queries filter by status='failed' ordered by time
  </action>
  <verify>
```bash
cd /workspaces/codespaces-django
grep -A10 "class Meta:" upstream/integrations/models.py | grep -E "(indexes|webhook_retry_idx|intlog_conn_time_idx)"
python manage.py makemigrations --dry-run --verbosity 2 | grep -E "(index|Index)"
```
  </verify>
  <done>
- WebhookDelivery has indexes for retry queries (status+next_attempt_at) and endpoint history
- IntegrationLog has indexes for connection history and status monitoring
- makemigrations detects 6 new indexes ready to create
  </done>
</task>

<task type="auto">
  <name>Create migration and verify index creation</name>
  <files>
    upstream/migrations/00XX_add_missing_indexes.py
  </files>
  <action>
1. Generate migration:
```bash
cd /workspaces/codespaces-django
python manage.py makemigrations upstream -n add_missing_indexes
```

2. Review migration file to ensure it includes:
   - db_index=True on UserProfile.user, UserProfile.customer
   - db_index=True on AlertRule.enabled, NotificationChannel.enabled
   - Composite index alertrule_cust_enabled_idx
   - Composite index notifchan_cust_enabled_idx
   - Composite index webhook_retry_idx
   - Composite index webhook_endpoint_hist_idx
   - Composite index intlog_conn_time_idx
   - Composite index intlog_status_time_idx

3. Apply migration:
```bash
python manage.py migrate upstream
```

4. Verify indexes in database:
```bash
python manage.py dbshell <<EOF
\d upstream_userprofile
\d upstream_alertrule
\d upstream_notificationchannel
\d upstream_webhookdelivery
\d upstream_integrationlog
\q
EOF
```

Expected: Each table shows new indexes in schema.

Why this approach:
- Single migration covers all index additions for atomic deployment
- Indexes are non-blocking in PostgreSQL (can add CONCURRENTLY in production)
- Review step catches any missing indexes before applying
  </action>
  <verify>
```bash
cd /workspaces/codespaces-django
ls -l upstream/migrations/*add_missing_indexes.py
python manage.py showmigrations upstream | tail -1
python manage.py sqlmigrate upstream $(ls upstream/migrations/*add_missing_indexes.py | grep -o '[0-9]\{4\}') | grep -c "CREATE INDEX"
```
  </verify>
  <done>
- Migration file exists with descriptive name
- Migration is applied (showmigrations shows [X])
- sqlmigrate shows 6+ CREATE INDEX statements
- No migration errors in output
  </done>
</task>

</tasks>

<verification>
1. Run test suite to ensure indexes don't break existing queries:
```bash
cd /workspaces/codespaces-django
python manage.py test upstream.tests --keepdb
```

2. Check EXPLAIN ANALYZE for improved query plans:
```sql
-- Before: seq scan on upstream_webhookdelivery
-- After: index scan on webhook_retry_idx
EXPLAIN ANALYZE SELECT * FROM upstream_webhookdelivery
WHERE status = 'retrying' AND next_attempt_at <= NOW()
ORDER BY next_attempt_at LIMIT 100;
```

3. Verify no duplicate indexes created:
```bash
python manage.py dbshell <<EOF
SELECT tablename, indexname FROM pg_indexes
WHERE schemaname = 'public'
  AND tablename IN ('upstream_userprofile', 'upstream_alertrule',
                    'upstream_notificationchannel', 'upstream_webhookdelivery',
                    'upstream_integrationlog')
ORDER BY tablename, indexname;
\q
EOF
```
</verification>

<success_criteria>
- [ ] UserProfile model has db_index on user and customer foreign keys
- [ ] AlertRule model has db_index on enabled field and composite customer+enabled index
- [ ] NotificationChannel model has db_index on enabled and composite customer+enabled+channel_type index
- [ ] WebhookDelivery model has indexes for retry queries and endpoint history
- [ ] IntegrationLog model has indexes for connection history and status monitoring
- [ ] Migration created with 6+ new indexes
- [ ] Migration applied successfully with no errors
- [ ] Test suite passes with new indexes
- [ ] Database schema confirms all indexes exist
</success_criteria>

<output>
After completion, create `.planning/phases/06-database-indexes/06-01-SUMMARY.md`
</output>
