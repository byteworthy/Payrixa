name: Deploy

on:
  push:
    tags:
      - 'v*'  # Triggered on version tags like v1.0.0
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'staging' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Notify deployment start
      if: secrets.SLACK_WEBHOOK_URL != '' || secrets.DISCORD_WEBHOOK_URL != ''
      continue-on-error: true
      run: |
        COMMIT_MSG=$(git log -1 --pretty=%B | head -n1)
        COMMIT_SHA_SHORT=$(git rev-parse --short HEAD)
        ENVIRONMENT="${{ github.event.inputs.environment || 'staging' }}"
        TRIGGERED_BY="${{ github.actor }}"

        # Slack notification
        if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
          curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "{\"text\":\"üöÄ *Deployment started*\n*Environment:* ${ENVIRONMENT}\n*Commit:* \`${COMMIT_SHA_SHORT}\` - ${COMMIT_MSG}\n*Triggered by:* ${TRIGGERED_BY}\"}"
        fi

        # Discord notification
        if [ -n "${{ secrets.DISCORD_WEBHOOK_URL }}" ]; then
          curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "{\"content\":\"üöÄ **Deployment started**\n**Environment:** ${ENVIRONMENT}\n**Commit:** \`${COMMIT_SHA_SHORT}\` - ${COMMIT_MSG}\n**Triggered by:** ${TRIGGERED_BY}\"}"
        fi

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Run tests before deploy
      run: |
        pip install -r requirements.txt
        python manage.py test --verbosity=0
      env:
        SECRET_KEY: ci-test-secret-key
        DEBUG: 'True'

    - name: Check migration safety
      run: |
        python scripts/validate_migrations.py --strict
      env:
        SECRET_KEY: ci-test-secret-key
        DEBUG: 'False'

    - name: Build Docker image
      run: |
        docker build -t upstream:${{ github.sha }} .

    - name: Deploy notification
      run: |
        echo "üöÄ Ready to deploy Upstream"
        echo "Environment: ${{ github.event.inputs.environment || 'staging' }}"
        echo "Commit: ${{ github.sha }}"
        echo "Tag: ${{ github.ref_name }}"
        echo ""
        echo "Configure your deployment target in this workflow:"
        echo "- AWS ECS, EKS, or App Runner"
        echo "- Google Cloud Run"
        echo "- Azure Container Apps"
        echo "- Railway, Render, or Fly.io"

    # TODO: Add actual deployment step here (Cloud Run, ECS, etc.)
    # - name: Deploy to staging/production
    #   run: |
    #     gcloud run deploy upstream ...

    - name: Run smoke tests
      if: vars.DEPLOYMENT_URL != ''
      run: |
        pip install requests
        python scripts/smoke_test.py --url "${{ vars.DEPLOYMENT_URL }}" --max-retries 3 --retry-delay 10
      env:
        DEPLOYMENT_URL: ${{ vars.DEPLOYMENT_URL }}

    - name: Run rollback validation test
      if: vars.DEPLOYMENT_URL != ''
      run: |
        pip install requests
        python scripts/test_rollback.py \
          --url "${{ vars.DEPLOYMENT_URL }}" \
          --timeout 60 \
          --retries 5 \
          --retry-delay 15
      env:
        DEPLOYMENT_URL: ${{ vars.DEPLOYMENT_URL }}

    - name: Notify deployment success
      if: success() && (secrets.SLACK_WEBHOOK_URL != '' || secrets.DISCORD_WEBHOOK_URL != '')
      continue-on-error: true
      run: |
        COMMIT_SHA_SHORT=$(git rev-parse --short HEAD)
        ENVIRONMENT="${{ github.event.inputs.environment || 'staging' }}"
        DEPLOYMENT_URL="${{ vars.DEPLOYMENT_URL }}"

        # Slack notification with green color
        if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
          curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "{\"attachments\":[{\"color\":\"good\",\"text\":\"‚úÖ *Deployment succeeded*\n*Environment:* ${ENVIRONMENT}\n*Commit:* \`${COMMIT_SHA_SHORT}\`\n*URL:* ${DEPLOYMENT_URL:-'Not configured'}\"}]}"
        fi

        # Discord notification
        if [ -n "${{ secrets.DISCORD_WEBHOOK_URL }}" ]; then
          curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "{\"content\":\"‚úÖ **Deployment succeeded**\n**Environment:** ${ENVIRONMENT}\n**Commit:** \`${COMMIT_SHA_SHORT}\`\n**URL:** ${DEPLOYMENT_URL:-'Not configured'}\"}"
        fi

    - name: Notify deployment failure
      if: failure() && (secrets.SLACK_WEBHOOK_URL != '' || secrets.DISCORD_WEBHOOK_URL != '')
      continue-on-error: true
      run: |
        COMMIT_SHA_SHORT=$(git rev-parse --short HEAD)
        ENVIRONMENT="${{ github.event.inputs.environment || 'staging' }}"
        RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

        # Slack notification with red color
        if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
          curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "{\"attachments\":[{\"color\":\"danger\",\"text\":\"‚ùå *Deployment failed*\n*Environment:* ${ENVIRONMENT}\n*Commit:* \`${COMMIT_SHA_SHORT}\`\n*View logs:* ${RUN_URL}\"}]}"
        fi

        # Discord notification
        if [ -n "${{ secrets.DISCORD_WEBHOOK_URL }}" ]; then
          curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "{\"content\":\"‚ùå **Deployment failed**\n**Environment:** ${ENVIRONMENT}\n**Commit:** \`${COMMIT_SHA_SHORT}\`\n**View logs:** ${RUN_URL}\"}"
        fi

  validate-rollback-script:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        pip install requests

    - name: Validate rollback script syntax
      run: |
        python -m py_compile scripts/test_rollback.py
        python scripts/test_rollback.py --help
